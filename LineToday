function NotifyLineToday() {
  var calendarId = "XXXXXXXXXXXXX"; // ID Calendar
  var token = "XXXXXXXXXXXXXXXXX"; // Line Token 
  var url = "https://notify-api.line.me/api/notify";
  
  var calendar = CalendarApp.getCalendarById(calendarId);
  var today = new Date();
  var event = calendar.getEventsForDay(today);
  var msg = "";
  
  var properties = PropertiesService.getScriptProperties();
  var lastEventIdsStr = properties.getProperty("lastEventIds");
  var lastEventIds = lastEventIdsStr ? JSON.parse(lastEventIdsStr) : {};

  if (event.length === 0) {
    msg = "\n‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏Å‡∏û‡∏™. (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)\n" + formatDateToday(today) +"\n(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°)";
  } else {
    msg += "\n‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏° ‡∏Å‡∏û‡∏™. (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)\n" + formatDateToday(today) + "\n‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î " + String(event.length) + " ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πà";
    msg += sendMessage(event);

    event.forEach(function (event) {
      var eventId = event.getId();
      lastEventIds[eventId] = true;
    });
  }

  properties.setProperty("lastEventIds", JSON.stringify(lastEventIds));

  var jsonData = {
    message: msg
  }
  var options =
  {
    "method": "post",
    "contentType": "application/x-www-form-urlencoded",
    "payload": jsonData,
    "headers": { "Authorization": "Bearer " + token }
  };
  var res = UrlFetchApp.fetch(url, options);
}

function NotifyLineOnCalendarChanges() {
  var calendarId = "XXXXXXXXXXXXXXX"; // ID Calendar
  var token = "XXXXXXXXXXXXXXXXXXX"; // Line Token 
  var url = "https://notify-api.line.me/api/notify";
  
  var calendar = CalendarApp.getCalendarById(calendarId);
  var properties = PropertiesService.getScriptProperties();
  var lastEventIdsStr = properties.getProperty("lastEventIds");
  var lastEventIds = lastEventIdsStr ? JSON.parse(lastEventIdsStr) : {};
  
  var today = new Date();
  var events = calendar.getEventsForDay(today);
  var msg = "";
  var addedEvents = [];
  var editedEvents = [];

  events.forEach(function (event) {
    var eventId = event.getId();
    var lastUpdatedTime = event.getLastUpdated().toISOString();

    if (!(eventId in lastEventIds) || lastUpdatedTime > lastEventIds[eventId]) {
      if (!(eventId in lastEventIds)) {
        addedEvents.push(event);
      } else {
        editedEvents.push(event);
      }

      lastEventIds[eventId] = lastUpdatedTime;
    }
  });

  if (addedEvents.length > 0) {
    msg += "\nüî•‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)üî•\n"+ formatDateToday(today) +"\n‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ\n\n";
    addedEvents.forEach(function (event) {
      var title = event.getTitle();
      var start = event.isAllDayEvent() ? "‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô" : event.getStartTime().getHours() + ":" + ("0" + event.getStartTime().getMinutes()).slice(-2);
      var end = event.isAllDayEvent() ? "" : " - " + event.getEndTime().getHours() + ":" + ("0" + event.getEndTime().getMinutes()).slice(-2) + " ‡∏ô.";
      var description = event.getDescription();
      var location = event.getLocation();

      msg += "‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á : " + title + "\n‡πÄ‡∏ß‡∏•‡∏≤ : " + start + end +  "\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î : " + description + "\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà : " + location;
    });
  }

  if (editedEvents.length > 0) {
    msg += "\nüõ†Ô∏è‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)üõ†Ô∏è\n"+ formatDateToday(today) +"\n‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ\n\n";
    editedEvents.forEach(function (event) {
      var title = event.getTitle();
      var start = event.isAllDayEvent() ? "‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô" : event.getStartTime().getHours() + ":" + ("0" + event.getStartTime().getMinutes()).slice(-2);
      var end = event.isAllDayEvent() ? "" : " - " + event.getEndTime().getHours() + ":" + ("0" + event.getEndTime().getMinutes()).slice(-2) + " ‡∏ô.";
      var description = event.getDescription();
      var location = event.getLocation();

      msg += "‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á : " + title + "\n‡πÄ‡∏ß‡∏•‡∏≤ : " + start + end +  "\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î : " + description + "\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà : " + location;
    });
  }

  if (addedEvents.length === 0 && editedEvents.length === 0) {
    return;
  }

  properties.setProperty("lastEventIds", JSON.stringify(lastEventIds));
  
  var jsonData = {
    message: msg
  }
  var options =
  {
    "method": "post",
    "contentType": "application/x-www-form-urlencoded",
    "payload": jsonData,
    "headers": { "Authorization": "Bearer " + token }
  };
  var res = UrlFetchApp.fetch(url, options);
}

function sendMessage(events) {
    var msg = "";
  events.forEach(function (event, index) {
    var title = event.getTitle();
    var start = event.isAllDayEvent() ? "‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô" : event.getStartTime().getHours() + ":" + ("0" + event.getStartTime().getMinutes()).slice(-2);
    var end = event.isAllDayEvent() ? "" : " - " + event.getEndTime().getHours() + ":" + ("0" + event.getEndTime().getMinutes()).slice(-2) + " ‡∏ô.";
    var description = event.getDescription();
    var location = event.getLocation();
    
    msg += "\n\n‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà " + (index + 1) + "\n‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á : " + title + "\n‡πÄ‡∏ß‡∏•‡∏≤ : " + start + end + "\n‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î : " + description + "\n‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà : " + location;
  });
  return msg;
}

function formatDateToday(date) {
  var dayOfWeek = ["‡∏ß‡∏±‡∏ô‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå", "‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå", "‡∏ß‡∏±‡∏ô‡∏≠‡∏±‡∏á‡∏Ñ‡∏≤‡∏£", "‡∏ß‡∏±‡∏ô‡∏û‡∏∏‡∏ò", "‡∏ß‡∏±‡∏ô‡∏û‡∏§‡∏´‡∏±‡∏™‡∏ö‡∏î‡∏µ", "‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå", "‡∏ß‡∏±‡∏ô‡πÄ‡∏™‡∏≤‡∏£‡πå"];
  var monthOfYear = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
  
  var day = date.getDate();
  var month = monthOfYear[date.getMonth()];
  var year = date.getFullYear() + 543;
  var dayIndex = date.getDay();
  var dayName = dayOfWeek[dayIndex];
  
  return dayName + "‡∏ó‡∏µ‡πà " + day + " " + month + " " + year;
}
